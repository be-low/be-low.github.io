---
layout: post
title: 使用 ArchLinux kvm 碰到的问题
date: 2019-03-23 15:43:22 +0800
categories: [linux, kvm]
---

参考 arch 的 [kvm wiki](https://wiki.archlinux.org/index.php/KVM)，执行了以下步骤

## 1. 安装需要的包

```shell
sudo pacman -Sy
sudo pacman -S qemu libvirt virt-manager
```

## 2. 启动服务

```shell
sudo systemctl enable --now libvirtd
```

现在应该可以用 `virt-manager` 创建虚拟机了

## 3. 此时本以为万事大吉了, 但是还会在创建网络连接时报错，参考 [libvirt wiki](https://wiki.archlinux.org/index.php/libvirt)

```shell
sudo pacman -S bridge-utils openbsd-netcat ebtables dnsmasq
```

然后重启 `libvirtd` 服务

```shell
sudo systemctl restart libvirtd
```

## 4. 重启后又出现了一个问题 

```shell
network 'default' is not active
```

那么把他启动就行了


```shell
sudo virsh net-start default
```

也可以自动启动

```shell
sudo virsh net-autostart default
```

## Optional

### 嵌套虚拟化


```
systool -m kvm_intel -v | grep nested
```

如果输出 `nested = "Y"`, 就是已经开启嵌套虚拟化,否则需要执行以下命令

```shell
echo "options kvm_intel nested=1" > /etc/modprobe.d/kvm_intel.conf
modprobe -r kvm_intel
modprobe kvm_intel
```

### 2. huge pages

- 使 kvm 组拥有 /dev/hugepages 的权限，添加下面这行到 `/etc/fstab`

```shell
hugetlbfs       /dev/hugepages  hugetlbfs       mode=1770,gid=78        0 0
```

- 然后重新挂载 `/dev/hugepages`

```shell
umount /dev/hugepages
mount /dev/hugepages
```

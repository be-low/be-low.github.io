---
layout: post
title: 在 ArchLinux 上使用 KVM 碰到的问题
date: 2019-03-23 15:43:22 +0800
categories: [linux, kvm]
---

## 1. 安装需要的包

```shell
sudo pacman -Sy
sudo pacman -S qemu libvirt virt-manager dmidecode
```

然后启动 `libvirtd` 服务

```shell
sudo systemctl enable --now libvirtd
```

现在应该可以用 `virt-manager` 创建虚拟机了

## 2. 但是还会在创建网络连接时报错

```shell
sudo pacman -S bridge-utils openbsd-netcat ebtables dnsmasq
```

然后重启 `libvirtd` 服务

```shell
sudo systemctl restart libvirtd
```

## 3. 重启后又出现了一个问题

```shell
network 'default' is not active
```

那么把他启动就行了


```shell
sudo virsh net-start default
```

自动启动

```shell
sudo virsh net-autostart default
```

**可选的功能:**

### 1. 嵌套虚拟化(Nested virtualization)

检查 `kvm_intel` 是否支持 `nested`


```
systool -m kvm_intel -v | grep nested
```

如果输出 `nested = "Y"`, 就是已经开启了,否则需要执行以下命令

```shell
echo "options kvm_intel nested=1" | sudo tee -a /etc/modprobe.d/kvm_intel.conf
sudo modprobe -r kvm_intel
sudo modprobe kvm_intel
```

### 2.  使用 huge pages 改善性能

看了下，最新版的 Arch 是会自动开启的，检查是否有`/dev/hugepages` 这个目录。如果没有的话，需要手动创建并：

- 使 kvm 组拥有 /dev/hugepages 的权限

  （Now we need the right permissions to use this directory. The default 
  permission is root's uid and gid with 0755, but we want anyone in the 
  kvm group to have access to hugepages.）

  添加到你的 `/etc/fstab`

```shell
hugetlbfs       /dev/hugepages  hugetlbfs       mode=1770,gid=78        0 0
```

这个 `gid` 应该是 `kvm` 组 的 id, 但是我的机器上它是 992, 所以应该用这个？

```shell
hugetlbfs       /dev/hugepages  hugetlbfs       mode=1770,gid=78        0 0
```



- 然后重新挂载 `/dev/hugepages`

```shell
sudo umount /dev/hugepages
sudo mount /dev/hugepages
```

## See also

- [Arch wiki libvirt](https://wiki.archlinux.org/index.php/libvirt)
- [Arch wiki kvm](https://wiki.archlinux.org/index.php/KVM)

> ps: 感觉看 Arch 的 wiki 就行了，我也不过翻译了一下，还是简化版的
{"componentChunkName":"component---src-components-post-jsx","path":"/post/Setup Kvm","result":{"data":{"markdownRemark":{"id":"a848baeb-f467-50fa-8be2-0cf26ef0e395","frontmatter":{"date":"March 23, 2019","draft":null,"tags":null,"title":"Setup Kvm"},"html":"<h2>1. 安装必需的包</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> pacman -Syu\n<span class=\"token function\">sudo</span> pacman -S qemu libvirt dmidecode bridge-utils openbsd-netcat ebtables dnsmasq</code></pre></div>\n<p>然后启动 <code class=\"language-text\">libvirtd</code> 服务</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> --now libvirtd</code></pre></div>\n<h2>2. 一个问题</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">network <span class=\"token string\">'default'</span> is not active</code></pre></div>\n<p>那么把他启动就行了</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">virsh</span> net-start default</code></pre></div>\n<p>自动启动</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">virsh</span> net-autostart default</code></pre></div>\n<p><strong>可选的功能:</strong></p>\n<h3>1. 使用 <code class=\"language-text\">Virtio</code> 进行半虚拟化（Para-virtualization with Virtio）</h3>\n<ul>\n<li>检测核心是否支持 <code class=\"language-text\">VIRTIO</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">zgrep VIRTIO /proc/config.gz</code></pre></div>\n<p>如果支持的话，所有的选项应该都为 <code class=\"language-text\">y</code> 或者 <code class=\"language-text\">m</code>, 就像这样:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">CONFIG_BLK_MQ_VIRTIO</span><span class=\"token operator\">=</span>y\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_VSOCKETS</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_VSOCKETS_COMMON</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_NET_9P_VIRTIO</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_BLK</span><span class=\"token operator\">=</span>m\n<span class=\"token comment\"># CONFIG_VIRTIO_BLK_SCSI is not set</span>\n<span class=\"token assign-left variable\">CONFIG_SCSI_VIRTIO</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_NET</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_CAIF_VIRTIO</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_CONSOLE</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_HW_RANDOM_VIRTIO</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_DRM_VIRTIO_GPU</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_MENU</span><span class=\"token operator\">=</span>y\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_PCI</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_PCI_LEGACY</span><span class=\"token operator\">=</span>y\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_BALLOON</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_INPUT</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_MMIO</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_VIRTIO_MMIO_CMDLINE_DEVICES</span><span class=\"token operator\">=</span>y\n<span class=\"token assign-left variable\">CONFIG_RPMSG_VIRTIO</span><span class=\"token operator\">=</span>m\n<span class=\"token assign-left variable\">CONFIG_CRYPTO_DEV_VIRTIO</span><span class=\"token operator\">=</span>m</code></pre></div>\n<ul>\n<li>检测核心模块 (kernel modules) 是否已加载</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">lsmod <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> virtio</code></pre></div>\n<p>如果没有输出任何东西的话，表示没有加载这个 <code class=\"language-text\">virtio</code> 这个模块</p>\n<p>这样加载模块</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">modprobe virtio</code></pre></div>\n<p>自动加载，添加到 <code class=\"language-text\">/etc/modules-load.d/&lt;module&gt;.conf</code>, <code class=\"language-text\">&lt;module</code>> 替换为模块的名字</p>\n<p>例如:</p>\n<p><code class=\"language-text\">/etc/modules-load.d/virtio.conf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">virtio\nvirtio-net\nvirtio-blk\nvirtio-scsi\nvirtio-balloon</code></pre></div>\n<p>还有一个 <code class=\"language-text\">virtio-serial</code> 会这样</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">modprobe: FATAL: Module virtio_serial not found <span class=\"token keyword\">in</span> directory /lib/modules/4.19.75-1-lts</code></pre></div>\n<h3>2. 嵌套虚拟化(Nested virtualization)</h3>\n<p>检查 <code class=\"language-text\">kvm_intel</code> 是否支持 <code class=\"language-text\">nested</code></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">systool -m kvm_intel -v <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> nested</code></pre></div>\n<p>如果输出 <code class=\"language-text\">nested = &quot;Y&quot;</code>, 就是已经开启了,否则需要执行以下命令</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"options kvm_intel nested=1\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> -a /etc/modprobe.d/kvm_intel.conf\n<span class=\"token function\">sudo</span> modprobe -r kvm_intel\n<span class=\"token function\">sudo</span> modprobe kvm_intel</code></pre></div>\n<h3>3. 使用 huge pages 改善性能</h3>\n<p>看了下，最新版的 Arch 是会自动开启的，检查是否有<code class=\"language-text\">/dev/hugepages</code> 这个目录。如果没有的话，需要手动创建并：</p>\n<ul>\n<li>\n<p>使 kvm 组拥有 /dev/hugepages 的权限</p>\n<p>（Now we need the right permissions to use this directory. The default\npermission is root's uid and gid with 0755, but we want anyone in the\nkvm group to have access to hugepages.）</p>\n<p>添加到你的 <code class=\"language-text\">/etc/fstab</code></p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">hugetlbfs       /dev/hugepages  hugetlbfs       <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span><span class=\"token number\">1770</span>,gid<span class=\"token operator\">=</span><span class=\"token number\">78</span>        <span class=\"token number\">0</span> <span class=\"token number\">0</span></code></pre></div>\n<p>这个 <code class=\"language-text\">gid</code> 应该是 <code class=\"language-text\">kvm</code> 组 的 id, 但是我的机器上它是 992, 所以应该用这个？</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">hugetlbfs       /dev/hugepages  hugetlbfs       <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span><span class=\"token number\">1770</span>,gid<span class=\"token operator\">=</span><span class=\"token number\">992</span>        <span class=\"token number\">0</span> <span class=\"token number\">0</span></code></pre></div>\n<ul>\n<li>然后重新挂载 <code class=\"language-text\">/dev/hugepages</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">umount</span> /dev/hugepages\n<span class=\"token function\">sudo</span> <span class=\"token function\">mount</span> /dev/hugepages</code></pre></div>\n<h3>4. 使用<code class=\"language-text\">libvirt</code> 的图形化管理工具 <code class=\"language-text\">virt-manager</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> pacman -S virt-manager</code></pre></div>\n<h2>See also</h2>\n<ul>\n<li><a href=\"https://wiki.archlinux.org/index.php/libvirt\">Arch wiki libvirt</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/KVM\">Arch wiki kvm</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/Kernel_module\">Arch woki Kernel module</a></li>\n</ul>"}},"pageContext":{"id":"a848baeb-f467-50fa-8be2-0cf26ef0e395"}},"staticQueryHashes":[]}